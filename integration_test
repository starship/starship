#!/bin/bash

if ! (docker --version); then
  printf 'Docker is required to run the starship integration tests.\n'
  printf 'Please download and install Docker in order to run these tests locally.\n'
  exit 1
fi

printf 'Pulling latest docker image'
docker pull starshipcommand/starship-test

printf 'Building test docker image:\n'
docker build -f tests/Dockerfile \
  --tag starshipcommand/starship-test \
  --cache-from starshipcommand/starship-test \
  .

printf 'Running test suite:\n'
# `seccomp=unconfined` is needed to allow tarpaulin to disable ASLR
# Details found here: https://github.com/xd009642/tarpaulin/issues/146
docker run --rm --security-opt seccomp=unconfined -v $(pwd):/starship starshipcommand/starship-test
